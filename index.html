<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catan Helper - Cities & Knights Companion</title>
  <meta name="description" content="A mobile-friendly helper for Settlers of Catan: Cities & Knights. Track resources, see what you can build, and get progress card descriptions.">
  <meta name="theme-color" content="#722f37">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öîÔ∏è</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --parchment-light: #f4e4bc;
      --parchment-mid: #e8d4a8;
      --burgundy: #722f37;
      --burgundy-dark: #4a1f24;
      --gold: #c9a227;
      --text-dark: #2c1810;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Crimson Text', Georgia, serif;
      font-size: 18px;
      line-height: 1.6;
      color: var(--text-dark);
      background: linear-gradient(135deg, #2c1810 0%, #4a3628 50%, #2c1810 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .title {
      font-family: 'Cinzel', serif;
      font-size: 2.5rem;
      color: var(--gold);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .subtitle {
      color: var(--parchment-light);
      font-style: italic;
      margin-top: 8px;
      font-size: 1.1rem;
    }

    .panel {
      background: linear-gradient(145deg, var(--parchment-light) 0%, var(--parchment-mid) 100%);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      border: 3px solid var(--burgundy);
    }

    h2 {
      font-family: 'Cinzel', serif;
      color: var(--burgundy);
      border-bottom: 2px solid var(--burgundy);
      padding-bottom: 10px;
      margin-bottom: 16px;
      font-size: 1.3rem;
    }

    .bookmarklet-link {
      display: inline-block;
      padding: 18px 36px;
      background: linear-gradient(180deg, var(--burgundy), var(--burgundy-dark));
      color: var(--gold);
      text-decoration: none;
      border-radius: 10px;
      font-family: 'Cinzel', serif;
      font-size: 1.3rem;
      font-weight: 600;
      border: 2px solid var(--gold);
      cursor: move;
      transition: transform 0.2s, box-shadow 0.2s;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .bookmarklet-link:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    }

    .bookmarklet-container {
      text-align: center;
      padding: 30px;
      background: rgba(255,255,255,0.3);
      border-radius: 8px;
      margin: 20px 0;
    }

    .steps {
      counter-reset: step;
      padding-left: 0;
      list-style: none;
    }

    .steps li {
      position: relative;
      padding-left: 50px;
      margin-bottom: 20px;
    }

    .steps li::before {
      counter-increment: step;
      content: counter(step);
      position: absolute;
      left: 0;
      top: 0;
      width: 36px;
      height: 36px;
      background: var(--burgundy);
      color: var(--gold);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel', serif;
      font-weight: bold;
    }

    code {
      background: rgba(0,0,0,0.1);
      padding: 2px 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
      word-break: break-all;
    }

    .mobile-section {
      background: rgba(33,150,243,0.1);
      border: 2px solid #2196f3;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .mobile-section h3 {
      color: #1565c0;
      margin-bottom: 12px;
      font-family: 'Cinzel', serif;
    }

    .mobile-section.android {
      border-color: #4caf50;
      background: rgba(76,175,80,0.1);
    }

    .mobile-section.android h3 {
      color: #2e7d32;
    }

    .mobile-steps {
      padding-left: 20px;
      margin: 0;
    }

    .mobile-steps li {
      margin-bottom: 10px;
    }

    .code-box {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
      margin: 15px 0;
      max-height: 120px;
      overflow-y: auto;
      user-select: all;
      -webkit-user-select: all;
    }

    .copy-btn {
      background: var(--burgundy);
      color: var(--gold);
      border: none;
      padding: 14px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      width: 100%;
      font-weight: 600;
      transition: background 0.2s;
    }

    .copy-btn:hover, .copy-btn:active {
      background: var(--burgundy-dark);
    }

    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .feature {
      background: rgba(255,255,255,0.4);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .feature-icon {
      font-size: 2.2rem;
      margin-bottom: 8px;
    }

    .feature-title {
      font-family: 'Cinzel', serif;
      color: var(--burgundy);
      margin: 0 0 8px 0;
      font-size: 1rem;
    }

    .feature p {
      font-size: 0.9rem;
      margin: 0;
      opacity: 0.9;
    }

    .footer {
      text-align: center;
      color: var(--parchment-mid);
      padding: 20px;
      font-size: 0.9rem;
    }

    .footer a {
      color: var(--gold);
    }

    .tip {
      background: rgba(255,193,7,0.2);
      border: 1px solid #ffc107;
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 0.95rem;
    }

    .tip strong {
      color: #ff8f00;
    }

    @media (max-width: 600px) {
      .container { padding: 16px 8px; }
      .title { font-size: 1.8rem; }
      .panel { padding: 16px; margin-bottom: 16px; }
      .steps li { padding-left: 45px; }
      .bookmarklet-link { padding: 14px 28px; font-size: 1.1rem; }
      .bookmarklet-container { padding: 20px 16px; }
      .mobile-section { padding: 16px; }
      .feature { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="title">‚öîÔ∏è Catan Helper</h1>
      <p class="subtitle">Cities & Knights Companion Tool</p>
    </header>

    <section class="panel">
      <h2>üñ•Ô∏è Desktop Installation</h2>
      <p>Drag this button to your bookmarks bar:</p>
      
      <div class="bookmarklet-container">
        <a class="bookmarklet-link" id="bookmarkletLink" href="#">
          ‚öîÔ∏è Catan Helper
        </a>
        <p style="margin-top: 16px; font-size: 0.95rem; opacity: 0.8;">or</p>
        <button class="copy-btn" style="margin-top: 12px; width: auto; padding: 12px 24px;" onclick="copyCode(this)">üìã Copy to Clipboard</button>
      </div>

      <div class="tip">
        <strong>üí° Tip:</strong> Can't see your bookmarks bar? Press <code>Ctrl+Shift+B</code> (Windows) or <code>Cmd+Shift+B</code> (Mac) to show it. Alternatively, copy the code and paste it as a bookmark URL.
      </div>
    </section>

    <section class="panel">
      <h2>üì± Mobile Installation</h2>
      
      <div class="mobile-section">
        <h3>üçé iPhone / Safari</h3>
        <ol class="mobile-steps">
          <li>Tap <strong>"Copy Code"</strong> below</li>
          <li>Bookmark any page (Share ‚Üí Add Bookmark)</li>
          <li>Open Bookmarks, find it, tap <strong>Edit</strong></li>
          <li>Delete the URL, <strong>paste the code</strong></li>
          <li>Save!</li>
        </ol>
      </div>

      <div class="mobile-section android">
        <h3>ü§ñ Android / Chrome</h3>
        <ol class="mobile-steps">
          <li>Tap <strong>"Copy Code"</strong> below</li>
          <li>Tap ‚ãÆ ‚Üí Bookmarks ‚Üí ‚ãÆ on any bookmark ‚Üí Edit</li>
          <li>Replace URL with <strong>pasted code</strong></li>
          <li>Or create new bookmark and paste as URL</li>
        </ol>
      </div>

      <div class="code-box" id="codeBox">Loading...</div>
      <button class="copy-btn" onclick="copyCode(this)">üìã COPY CODE</button>
    </section>

    <section class="panel">
      <h2>üéÆ How to Use</h2>
      <ol class="steps">
        <li>
          <strong>Open your Catan game</strong><br>
          Go to your game at <code>g.csdu.co.uk</code>
        </li>
        <li>
          <strong>Activate the helper</strong><br>
          Click the bookmarklet (desktop) or type its name in the URL bar (mobile)
        </li>
        <li>
          <strong>View your dashboard</strong><br>
          See resources, building options, dev tracks & card descriptions
        </li>
      </ol>

      <div class="tip">
        <strong>üì± Mobile tip:</strong> The helper covers the full screen. Tap "Show Game" to see the board, run the bookmarklet again to bring back the helper.
      </div>
    </section>

    <section class="panel">
      <h2>‚ú® Features</h2>
      <div class="features">
        <div class="feature">
          <div class="feature-icon">üì¶</div>
          <h3 class="feature-title">Resources</h3>
          <p>All resources & commodities at a glance</p>
        </div>
        <div class="feature">
          <div class="feature-icon">üèõÔ∏è</div>
          <h3 class="feature-title">Dev Tracks</h3>
          <p>Trade, Science & Politics levels</p>
        </div>
        <div class="feature">
          <div class="feature-icon">üî®</div>
          <h3 class="feature-title">Build Guide</h3>
          <p>See what you can afford to build</p>
        </div>
        <div class="feature">
          <div class="feature-icon">üìú</div>
          <h3 class="feature-title">Card Info</h3>
          <p>Full descriptions of progress cards</p>
        </div>
      </div>
    </section>

    <footer class="footer">
      <p>‚öîÔ∏è Catan Helper ‚Ä¢ Not affiliated with Catan GmbH<br>
      <a href="https://github.com" target="_blank">View on GitHub</a></p>
    </footer>
  </div>

  <script>
    // Mobile-optimized bookmarklet code - clean footer UI, compact resources, auto-reconnect
    const bookmarkletCode = `javascript:(function(){if(!location.hostname.includes("csdu.co.uk")){alert("Open this on g.csdu.co.uk with your game!");return}var C={200:{n:"Alchemist",c:"science",i:"üß™",d:"Choose dice result for resource production"},201:{n:"Crane",c:"science",i:"üèóÔ∏è",d:"Build city improvement for 1 less commodity"},202:{n:"Engineer",c:"science",i:"‚öôÔ∏è",d:"Build a city wall for free"},203:{n:"Inventor",c:"science",i:"üí°",d:"Swap 2 number tokens (not 6, 8, 2, 12)"},204:{n:"Irrigation",c:"science",i:"üíß",d:"Each settlement on grain gets 2 grain"},205:{n:"Medicine",c:"science",i:"üíä",d:"Upgrade settlement to city for 2 ore + 1 grain"},206:{n:"Mining",c:"science",i:"‚õèÔ∏è",d:"Each settlement on ore/mountains gets 2 ore"},207:{n:"Printer",c:"science",i:"üì∞",d:"+1 Victory Point (keep until played)"},208:{n:"Road Building",c:"science",i:"üõ§Ô∏è",d:"Build 2 roads for free"},209:{n:"Smith",c:"science",i:"üî®",d:"Promote 2 knights for free"},300:{n:"Commercial Harbor",c:"trade",i:"‚öì",d:"Force opponents to give you 1 commodity each (1 per their VP)"},301:{n:"Master Merchant",c:"trade",i:"üé©",d:"Look at opponent hand, take 2 cards"},302:{n:"Merchant",c:"trade",i:"üßë‚Äçüíº",d:"Place merchant for 2:1 trade + 1 VP"},303:{n:"Merchant Fleet",c:"trade",i:"‚õµ",d:"Trade any resource 2:1 this turn"},304:{n:"Resource Monopoly",c:"trade",i:"üíé",d:"Name a resource, each player gives you 2"},305:{n:"Trade Monopoly",c:"trade",i:"üëë",d:"Name a commodity, each player gives you 1"},400:{n:"Bishop",c:"politics",i:"‚úùÔ∏è",d:"Move robber, take 1 card from each adjacent player"},401:{n:"Constitution",c:"politics",i:"üìú",d:"+1 Victory Point (keep until played)"},402:{n:"Deserter",c:"politics",i:"üèÉ",d:"Remove any opponent knight from the board"},403:{n:"Diplomat",c:"politics",i:"ü§ù",d:"Remove any open road (yours or opponent)"},404:{n:"Intrigue",c:"politics",i:"üó°Ô∏è",d:"Displace opponent knight to move yours there"},405:{n:"Saboteur",c:"politics",i:"üí£",d:"All opponents with more VP discard half their hand"},406:{n:"Spy",c:"politics",i:"üïµÔ∏è",d:"Look at opponent progress cards, steal 1"},407:{n:"Warlord",c:"politics",i:"‚öîÔ∏è",d:"Activate all your knights for free"},408:{n:"Wedding",c:"politics",i:"üíí",d:"Each player with more VP gives you 2 cards"}};var B={road:{n:"Road",i:"üõ£Ô∏è",c:{lumber:1,brick:1}},settlement:{n:"Settlement",i:"üè†",c:{lumber:1,brick:1,wool:1,grain:1}},city:{n:"City",i:"üè∞",c:{grain:2,ore:3}},wall:{n:"Wall",i:"üß±",c:{brick:2}},knight:{n:"Knight",i:"‚öîÔ∏è",c:{wool:1,ore:1}},activate:{n:"Activate",i:"üõ°Ô∏è",c:{grain:1}},promote:{n:"Strong",i:"üí™",c:{wool:1,ore:1}},mighty:{n:"Mighty",i:"ü¶∏",c:{wool:1,ore:1}}};var p=new URLSearchParams(location.search);var gid=p.get("game_id"),pid=parseInt(p.get("player_id"))||1;if(!gid){alert("No game_id found in URL!");return}var wakeLock=null,noSleepVideo=null,playerData=null;function updateWakeInd(on){var ind=document.getElementById("chWakeInd");if(ind)ind.style.opacity=on?"1":"0.3"}async function requestWakeLock(){if("wakeLock"in navigator){try{wakeLock=await navigator.wakeLock.request("screen");wakeLock.addEventListener("release",function(){updateWakeInd(false)});updateWakeInd(true)}catch(e){startNoSleep()}}else{startNoSleep()}}function releaseWakeLock(){if(wakeLock){wakeLock.release();wakeLock=null}stopNoSleep();updateWakeInd(false)}function startNoSleep(){if(noSleepVideo)return;noSleepVideo=document.createElement("video");noSleepVideo.setAttribute("playsinline","");noSleepVideo.setAttribute("muted","");noSleepVideo.muted=true;noSleepVideo.loop=true;noSleepVideo.style.cssText="position:fixed;top:-1px;left:-1px;width:1px;height:1px;opacity:0.01;pointer-events:none;z-index:-1";noSleepVideo.src="data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAA7RtZGF0AAACrwYF//+r3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE1MiByMjg1NCBlOWE1OTAzIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNyAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTMgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfbWluPTEgc2NlbmVjdXQ9NDAgaW50cmFfcmVmcmVzaD0wIHJjX2xvb2thaGVhZD00MCByYz1jcmYgbWJ0cmVlPTEgY3JmPTIzLjAgcWNvbXA9MC42MCBxcG1pbj0wIHFwbWF4PTY5IHFwc3RlcD00IGlwX3JhdGlvPTEuNDAgYXE9MToxLjAwAIAAAAAwZYiEAD//8m+P5OXfBeLGOfKE3xkODvFZuBflHv/+VwJIta6cbpIo8s6pycmMX+QQfQLtAAAACkGaJGxBD0kgAAAAB0GeQniEHwAAAAcBnmF0Qg8AAAAHAZpiakIPAAAADUGaZkmoQQ/+AQAAAAMAAAADZ2RvdmgAAAAMZHBpeAAAAACwAAAADW5vcm0AAAABAAAAAHdpZHRoAAAAgAAAABBoZWlnaHQAAACAAAAADHByb2oAAAAAAAAAbmNscwAAAAAAAAAAbWF0cgAAAAAAAAAAAAAAAAAAAABwbHVyAAAAHGRwcmMAAAAAAAAAAAAAAAAAAABpbnRlAAAAFGJsdXIAAAABAHByb3AAAAAKb3JkZXIAAAAB";document.body.appendChild(noSleepVideo);noSleepVideo.play().catch(function(){})}function stopNoSleep(){if(noSleepVideo){noSleepVideo.pause();noSleepVideo.remove();noSleepVideo=null}}function handleVisChange(){if(document.visibilityState==="visible"&&document.getElementById("ch-overlay")&&document.getElementById("ch-overlay").style.display!=="none"){requestWakeLock();if(!ws||ws.readyState!==1){connect()}}}var clr={Red:"#e53935",Blue:"#1e88e5",Green:"#43a047",Yellow:"#fdd835",Orange:"#fb8c00",Brown:"#6d4c41"};function updateFooter(){var f=document.getElementById("chFooter");if(f&&playerData){f.querySelector(".chFc").style.background=clr[playerData.colour]||"#666";f.querySelector(".chFc").textContent=(playerData.colour||"?")[0];f.querySelector(".chFn").textContent=playerData.colour}}var o=document.createElement("div");o.id="ch-overlay";o.innerHTML='<style>*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}html.ch-open,body.ch-open{overflow:hidden!important;position:fixed!important;width:100%!important;height:100%!important;touch-action:none}#ch-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:#1a1210;font-family:-apple-system,system-ui,sans-serif;color:#f4e4bc;z-index:999999;display:flex;flex-direction:column;height:100%}.chScroll{flex:1;min-height:0;overflow-x:hidden;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;padding:12px;padding-top:max(12px,env(safe-area-inset-top));padding-left:max(12px,env(safe-area-inset-left));padding-right:max(12px,env(safe-area-inset-right));padding-bottom:12px}.chS{background:rgba(244,228,188,.06);border-radius:10px;padding:12px;margin-bottom:10px}.chT{font-weight:600;color:#c9a227;font-size:13px;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px}.chRes{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}.chRi{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.1);padding:8px 12px;border-radius:20px}.chRi .em{font-size:18px}.chRi .num{font-weight:700;font-size:22px;min-width:18px;text-align:center}.chComm{margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.08)}.chDv{display:flex;flex-direction:column;gap:8px}.chDt{display:flex;align-items:center;gap:8px}.chDl{font-size:13px;min-width:75px;flex-shrink:0}.chDb{flex:1;height:22px;background:rgba(0,0,0,.4);border-radius:11px;overflow:hidden;position:relative}.chDf{height:100%;border-radius:11px}.chDf.trade{background:linear-gradient(90deg,#c2b44b,#ffeb3b)}.chDf.science{background:linear-gradient(90deg,#2e7d32,#66bb6a)}.chDf.politics{background:linear-gradient(90deg,#1565c0,#42a5f5)}.chDn{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:700;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.7)}.chB{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}.chBi{padding:10px;border-radius:8px;display:flex;align-items:center;gap:8px}.chBi.y{background:rgba(76,175,80,.2);border:1px solid rgba(76,175,80,.5)}.chBi.n{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);opacity:.35}.chBi .icon{font-size:22px}.chBi .info{flex:1;min-width:0}.chBi .name{font-weight:600;font-size:13px}.chBi .cost{font-size:11px;opacity:.7;margin-top:1px}.chCds{display:flex;flex-direction:column;gap:8px}.chCi{padding:10px 12px;border-radius:8px;border-left:3px solid}.chCi.science{border-color:#66bb6a;background:rgba(102,187,106,.1)}.chCi.trade{border-color:#ffeb3b;background:rgba(255,235,59,.08)}.chCi.politics{border-color:#42a5f5;background:rgba(66,165,245,.1)}.chCh{display:flex;gap:8px;align-items:center;margin-bottom:3px}.chCh .icon{font-size:16px}.chCn{font-weight:600;font-size:13px}.chCd-desc{font-size:12px;opacity:.8;line-height:1.3}.chF{background:linear-gradient(180deg,rgba(74,31,36,.95),rgba(44,24,16,.98));padding:10px 14px;padding-bottom:max(10px,env(safe-area-inset-bottom));padding-left:max(14px,env(safe-area-inset-left));padding-right:max(14px,env(safe-area-inset-right));display:flex;align-items:center;gap:10px;flex-shrink:0;border-top:1px solid rgba(201,162,39,.2)}.chFc{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;color:#fff;font-weight:700;flex-shrink:0;box-shadow:0 2px 4px rgba(0,0,0,.3)}.chFi{flex:1;min-width:0}.chFn{font-size:14px;font-weight:600;color:#f4e4bc}.chFs{font-size:10px;display:flex;align-items:center;gap:4px;margin-top:1px}.chFs.on{color:#4caf50}.chFs.off{color:#ff9800}.chTog{background:#c9a227;color:#2c1810;border:0;padding:8px 14px;border-radius:6px;font-weight:600;font-size:12px;cursor:pointer;flex-shrink:0}.chWake{opacity:0.3;transition:opacity 0.3s}</style><div class="chScroll" id="chScroll"><div id="chContent"><div style="text-align:center;padding:40px;opacity:.6">Connecting...</div></div></div><div class="chF" id="chFooter"><div class="chFc">?</div><div class="chFi"><div class="chFn">Connecting...</div><div class="chFs off" id="chStatus">‚óè connecting<span id="chWakeInd" class="chWake"> ‚òÄÔ∏è</span></div></div><button class="chTog" id="chTogBtn">Show Game</button></div>';var existing=document.getElementById("ch-overlay");if(existing){var isHidden=existing.style.display==="none";existing.style.display=isHidden?"flex":"none";document.documentElement.classList.toggle("ch-open",isHidden);document.body.classList.toggle("ch-open",isHidden);if(isHidden){requestWakeLock();if(!ws||ws.readyState!==1)connect()}else{releaseWakeLock()}return}document.body.appendChild(o);document.documentElement.classList.add("ch-open");document.body.classList.add("ch-open");requestWakeLock();document.addEventListener("visibilitychange",handleVisChange);document.getElementById("chTogBtn").onclick=function(){if(intv)clearInterval(intv);if(reconnectTimer)clearTimeout(reconnectTimer);if(ws&&ws.readyState===1)ws.close();releaseWakeLock();document.removeEventListener("visibilitychange",handleVisChange);document.getElementById("ch-overlay").style.display="none";document.documentElement.classList.remove("ch-open");document.body.classList.remove("ch-open")};var ws,ref=0,jref,intv,reconnectAttempts=0,reconnectTimer;function setStatus(txt,online){var s=document.getElementById("chStatus");if(s){var w=document.getElementById("chWakeInd");s.innerHTML="‚óè "+txt+(w?"<span id=\\'chWakeInd\\' class=\\'chWake\\'"+((w.style.opacity==="1")?" style=\\'opacity:1\\'":"")+"> ‚òÄÔ∏è</span>":"");s.className="chFs "+(online?"on":"off")}}function connect(){if(reconnectTimer)clearTimeout(reconnectTimer);if(ws&&ws.readyState<2)return;setStatus("connecting...",false);try{ws=new WebSocket("wss://fern-service.csdu.co.uk/socket/websocket?vsn=2.0.0")}catch(e){scheduleReconnect();return}ws.onopen=function(){reconnectAttempts=0;setStatus("live",true);jref=String(++ref);ws.send(JSON.stringify([jref,String(++ref),"catan_game:"+gid,"phx_join",{client_id:"CH_"+Math.random().toString(36).substr(2,5)}]))};ws.onmessage=function(e){try{var m=JSON.parse(e.data);if(m[3]==="phx_reply"&&m[4].status==="ok"&&m[1]==="2"){if(intv)clearInterval(intv);setTimeout(function(){if(ws&&ws.readyState===1){ws.send(JSON.stringify([jref,String(++ref),"catan_game:"+gid,"game_state",""]));intv=setInterval(function(){if(ws&&ws.readyState===1)ws.send(JSON.stringify([jref,String(++ref),"catan_game:"+gid,"game_state",""]))},5000)}},300)}if(m[4]&&m[4].game_state)render(m[4].game_state)}catch(x){}};ws.onerror=function(){setStatus("error",false)};ws.onclose=function(){setStatus("offline",false);if(intv){clearInterval(intv);intv=null}scheduleReconnect()}}function scheduleReconnect(){var ov=document.getElementById("ch-overlay");if(ov&&ov.style.display!=="none"&&reconnectAttempts<15){var delay=Math.min(2000*Math.pow(1.5,reconnectAttempts),60000);reconnectAttempts++;setStatus("reconnecting in "+Math.round(delay/1000)+"s...",false);reconnectTimer=setTimeout(connect,delay)}}connect();function render(gs){var pl=gs.players.find(function(x){return x.id===pid})||gs.players[0];playerData=pl;updateFooter();var ck=pl.cities_knights||{};var r={lumber:pl.lumber||0,brick:pl.brick||0,wool:pl.wool||0,grain:pl.grain||0,ore:pl.ore||0,cloth:ck.cloth||0,coin:ck.coin||0,paper:ck.paper||0};var tLv=ck.trade||0,sLv=ck.science||0,pLv=ck.politics||0;var h="<div class=\\'chS\\'><div class=\\'chT\\'>Resources</div><div class=\\'chRes\\'>";h+="<div class=\\'chRi\\'><span class=\\'em\\'>ü™µ</span><span class=\\'num\\'>"+r.lumber+"</span></div>";h+="<div class=\\'chRi\\'><span class=\\'em\\'>üß±</span><span class=\\'num\\'>"+r.brick+"</span></div>";h+="<div class=\\'chRi\\'><span class=\\'em\\'>üêë</span><span class=\\'num\\'>"+r.wool+"</span></div>";h+="<div class=\\'chRi\\'><span class=\\'em\\'>üåæ</span><span class=\\'num\\'>"+r.grain+"</span></div>";h+="<div class=\\'chRi\\'><span class=\\'em\\'>ü™®</span><span class=\\'num\\'>"+r.ore+"</span></div></div>";h+="<div class=\\'chRes chComm\\'>";h+="<div class=\\'chRi\\'><span class=\\'em\\'>üß∂</span><span class=\\'num\\'>"+r.cloth+"</span></div>";h+="<div class=\\'chRi\\'><span class=\\'em\\'>ü™ô</span><span class=\\'num\\'>"+r.coin+"</span></div>";h+="<div class=\\'chRi\\'><span class=\\'em\\'>üìú</span><span class=\\'num\\'>"+r.paper+"</span></div></div></div>";h+="<div class=\\'chS\\'><div class=\\'chT\\'>Development</div><div class=\\'chDv\\'>";h+="<div class=\\'chDt\\'><span class=\\'chDl\\'>üü° Trade</span><div class=\\'chDb\\'><div class=\\'chDf trade\\' style=\\'width:"+(tLv*20)+"%\\'></div><span class=\\'chDn\\'>"+tLv+"/5</span></div></div>";h+="<div class=\\'chDt\\'><span class=\\'chDl\\'>üü¢ Science</span><div class=\\'chDb\\'><div class=\\'chDf science\\' style=\\'width:"+(sLv*20)+"%\\'></div><span class=\\'chDn\\'>"+sLv+"/5</span></div></div>";h+="<div class=\\'chDt\\'><span class=\\'chDl\\'>üîµ Politics</span><div class=\\'chDb\\'><div class=\\'chDf politics\\' style=\\'width:"+(pLv*20)+"%\\'></div><span class=\\'chDn\\'>"+pLv+"/5</span></div></div></div></div>";h+="<div class=\\'chS\\'><div class=\\'chT\\'>Build</div><div class=\\'chB\\'>";function canBuild(c){for(var k in c)if((r[k]||0)<c[k])return false;return true}function costStr(c){var s=[];var icons={lumber:"ü™µ",brick:"üß±",wool:"üêë",grain:"üåæ",ore:"ü™®"};for(var k in c)s.push(c[k]+icons[k]);return s.join(" ")}for(var k in B){var b=B[k],ok=canBuild(b.c);h+="<div class=\\'chBi "+(ok?"y":"n")+"\\'><span class=\\'icon\\'>"+b.i+"</span><div class=\\'info\\'><div class=\\'name\\'>"+b.n+"</div><div class=\\'cost\\'>"+costStr(b.c)+"</div></div></div>"}var nxtT=tLv+1,nxtS=sLv+1,nxtP=pLv+1;if(tLv<5){h+="<div class=\\'chBi "+(r.cloth>=nxtT?"y":"n")+"\\'><span class=\\'icon\\'>üü°</span><div class=\\'info\\'><div class=\\'name\\'>Trade "+nxtT+"</div><div class=\\'cost\\'>"+nxtT+"üß∂</div></div></div>"}if(sLv<5){h+="<div class=\\'chBi "+(r.paper>=nxtS?"y":"n")+"\\'><span class=\\'icon\\'>üü¢</span><div class=\\'info\\'><div class=\\'name\\'>Science "+nxtS+"</div><div class=\\'cost\\'>"+nxtS+"üìú</div></div></div>"}if(pLv<5){h+="<div class=\\'chBi "+(r.coin>=nxtP?"y":"n")+"\\'><span class=\\'icon\\'>üîµ</span><div class=\\'info\\'><div class=\\'name\\'>Politics "+nxtP+"</div><div class=\\'cost\\'>"+nxtP+"ü™ô</div></div></div>"}h+="</div></div>";var cds=ck.progress_cards||[];h+="<div class=\\'chS\\'><div class=\\'chT\\'>Cards ("+cds.length+")</div><div class=\\'chCds\\'>";if(cds.length===0)h+="<div style=\\'opacity:.5;text-align:center;padding:12px;font-size:12px\\'>No progress cards yet</div>";for(var i=0;i<cds.length;i++){var cd=C[cds[i]]||{n:"Unknown",c:"science",i:"‚ùì",d:"Unknown card"};h+="<div class=\\'chCi "+cd.c+"\\'><div class=\\'chCh\\'><span class=\\'icon\\'>"+cd.i+"</span><span class=\\'chCn\\'>"+cd.n+"</span></div><div class=\\'chCd-desc\\'>"+cd.d+"</div></div>"}h+="</div></div>";var scrollEl=document.getElementById("chScroll");var scrollPos=scrollEl.scrollTop;document.getElementById("chContent").innerHTML=h;scrollEl.scrollTop=scrollPos}})();`;

    // Set the bookmarklet href
    document.getElementById('bookmarkletLink').href = bookmarkletCode;
    document.getElementById('codeBox').textContent = bookmarkletCode;

    function copyCode(btn) {
      const originalText = btn.textContent;

      function showSuccess() {
        btn.textContent = '‚úÖ Copied!';
        btn.style.background = '#4caf50';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 2000);
      }

      function showError() {
        prompt('Copy this code manually:', bookmarkletCode);
      }

      navigator.clipboard.writeText(bookmarkletCode).then(showSuccess).catch(() => {
        // Fallback for older browsers / iOS
        const ta = document.createElement('textarea');
        ta.value = bookmarkletCode;
        ta.style.cssText = 'position:fixed;opacity:0;top:0;left:0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        try {
          document.execCommand('copy');
          showSuccess();
        } catch(e) {
          showError();
        }
        document.body.removeChild(ta);
      });
    }
  </script>
</body>
</html>
